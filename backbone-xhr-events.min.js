/*!
 * https://github.com/jhudson8/backbone-xhr-events v0.9.5;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=e:e(Backbone,_)}(function(e,t){function r(e){e=e||"_all";var t=l[e];return t||(t=function(t,r){"_all"!==e&&(r=t,t=e),n(r.method,this,r.model,r.options)},l[e]=t),t}function n(e,t,r,n){function s(e){var r=n[e];n[e]=function(n,a,s){function h(n){try{!r||n&&n.preventCallbacks||r.apply(c,v.args)}finally{var a=u.indexOf(v);a>=0&&u.splice(a,1),0===u.length&&(t[i]=void 0,t.trigger(o,v))}var s=e===f?[e,v]:[e,d[0],d[1],d[2],v];v.trigger.apply(v,s),n&&n.preventEvents||(s.splice(0,0,"complete"),v.trigger.apply(v,s))}var c=this,d=v.args=[n,a,s];v.finish=h,(e!==f||v._defaultPrevented||(v.trigger("after-send",n,a,s,e,v),d[0]=v.data||d[0],!v._defaultPrevented))&&v.finish()}}var u=t[i]=t[i]||[],l=n&&n.event||e,v=new d(e,r,n),p=a+":"+l;t.trigger(a,l,v),t.trigger(p,v),t===r&&(h.trigger(a,l,t,v),h.trigger(p,t,v));var g=n.beforeSend;return n.beforeSend=function(e,t){if(v.xhr=e,v.settings=t,g){var r=g.call(this,e,t);if(r===!1)return r}return v.trigger("before-send",e,t,v),v._defaultPrevented?!1:void u.push(v)},s(f),s(c),v}var o=e.xhrCompleteEventName=e.xhrCompleteEventName||"xhr:complete",i=e.xhrModelLoadingAttribute=e.xhrModelLoadingAttribute||"xhrActivity",a=e.xhrEventName=e.xhrEventName||"xhr",s=e.xhrGlobalAttribute=e.xhrGlobalAttribute||"xhrEvents",h=e[s]=t.extend({},e.Events),f="success",c="error",d=function(e,t,r){this.method=e,this.model=t,this.options=r};d.prototype.abort=function(){this.aborted||(this.aborted=!0,this.preventDefault=!0,this.xhr&&this.xhr.abort())},d.prototype.preventDefault=function(){this._defaultPrevented=!0},t.extend(d.prototype,e.Events);var u=e.sync;e.sync=function(e,r,o){o=o||{},o.url||(o.url=t.result(r,"url"));var i=n(e,r,r,o);if(!i._defaultPrevented){var a=u.call(this,e,r,o);return i.xhr=a,a}},h.on(a+":read",function(e,t){t.on(f,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(c,function(){e.hadFetchError=!0})}),e.Model.prototype.whenFetched=e.Collection.whenFetched=function(e,r){function n(){e(o)}var o=this;if(this.hasBeenFetched)return e(this);var a=t.find(this[i],function(e){return"read"===e.method});a?(a.on("success",n),r&&a.on("error",r)):this.fetch({success:n,error:r})},e.forwardXhrEvents=e.forwardXHREvents=function(e,n,o){var i=r(!t.isFunction(o)&&o);if(t.isFunction(o))try{e.on(a,i,n),o.call(this)}finally{e.off(a,i,n)}else{var s=o?a+":"+o:a;e.on(s,i,n)}},e.stopXhrForwarding=e.stopXHRForwarding=function(e,t,n){var o=r(n);e.off(a,o,t)};var l={};t.each({reset:e.Collection,clear:e.Model},function(e,r){var n=e.prototype[r];e.prototype[r]=function(e){("clear"===r||t.isUndefined(e))&&(this.hasBeenFetched=this.hadFetchError=!1),n.apply(this,arguments)}})});
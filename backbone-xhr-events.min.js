/*!
 * https://github.com/jhudson8/backbone-xhr-events v0.6.1;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(t,r){e(t,r)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t){e(t,require("underscore"))}:e(Backbone,_)}(function(e,t){function r(e){e=e||"_all";var t=l[e];return t||(t=function(t,r){"_all"!==e&&(options=r,r=t,t=e),n(this,r.model,r.options,r.method)},l[e]=t),t}function n(r,n,u,f){function l(e){var t=u[e];u[e]=function(c,u,s){if(e!==a||v.stop||(v.trigger("data",c,u,s,v),c=v.response||c,!v.preventDefault)){t&&t.call(this,c,u,s);var h=d.indexOf(v);h>=0&&d.splice(h,1),0===d.length&&(r[i]=void 0,r.trigger(o,v));var f=e===a?[e,n,v]:[e,n,c,u,s,v];v.trigger.apply(v,f),f.splice(0,0,"complete"),v.trigger.apply(v,f)}}}var d=r[i]=r[i]||[],p=u&&u.event||f,v=t.extend({},e.Events);v.method=f,v.options=u,v.model=n,d.push(v);var g=c+":"+p;return r.trigger(c,p,v),r.trigger(g,v),r===n&&(s.trigger(c,p,r,v),s.trigger(g,r,v)),l(a),l(h),v}var o=e.xhrCompleteEventName=e.xhrCompleteEventName||"xhr:complete",i=e.xhrModelLoadingAttribute=e.xhrModelLoadingAttribute||"xhrActivity",c=e.xhrEventName=e.xhrEventName||"xhr",u=e.xhrGlobalAttribute=e.xhrGlobalAttribute||"xhrEvents",s=e[u]=t.extend({},e.Events),a="success",h="error",f=e.sync;e.sync=function(e,r,o){o=o||{},o.url||(o.url=t.result(r,"url"));var i=n(r,r,o,e),c=i.intercept;if(c){if(t.isFunction(c))return c(o);throw new Error("intercept must be function(options)")}return i.xhr=f.call(this,e,r,o),i.xhr},s.on(c+":read",function(e,t){t.on(a,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(h,function(){e.hadFetchError=!0})}),e.Model.prototype.whenFetched=e.Collection.whenFetched=function(e,r){if(this.hasBeenFetched)return e(this);var n=t.find(this[i],function(e){return"read"===e.method});n?(n.on("success",e),r&&n.on("error",r)):this.fetch({success:e,error:r})},e.forwardXhrEvents=function(e,n,o){var i=r(!t.isFunction(o)&&o);if(t.isFunction(o))try{e.on(c,i,n),o.call(this)}finally{e.off(c,i,n)}else{var u=o?c+":"+o:c;e.on(u,i,n)}},e.stopXhrForwarding=function(e,t,n){var o=r(n);e.off(c,o,t)};var l={}});
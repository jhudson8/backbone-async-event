/*!
 * https://github.com/jhudson8/backbone-xhr-events v0.9.2;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=e:e(Backbone,_)}(function(e,t){function r(e){e=e||"_all";var t=d[e];return t||(t=function(t,r){"_all"!==e&&(options=r,r=t,t=e),n(r.method,this,r.model,r.options)},d[e]=t),t}function n(e,t,r,n){function h(e){var r=n[e];n[e]=function(n,a,h){if(e!==c||p.preventDefault||(p.trigger("after-send",n,a,h,e,p),n=p.data||n,!p.preventDefault)){try{r&&r.call(this,n,a,h)}finally{var s=l.indexOf(p);s>=0&&l.splice(s,1),0===l.length&&(t[i]=void 0,t.trigger(o,p))}var f=e===c?[e,p]:[e,n,a,h,p];p.trigger.apply(p,f),f.splice(0,0,"complete"),p.trigger.apply(p,f)}}}var l=t[i]=t[i]||[],d=n&&n.event||e,p=new u(e,r,n),v=a+":"+d;t.trigger(a,d,p),t.trigger(v,p),t===r&&(s.trigger(a,d,t,p),s.trigger(v,t,p));var g=n.beforeSend;return n.beforeSend=function(e,t){if(p.xhr=e,p.settings=t,g){var r=g.call(this,e,t);if(r===!1)return r}return p.trigger("before-send",e,t,p),p.preventDefault?!1:void l.push(p)},h(c),h(f),p}var o=e.xhrCompleteEventName=e.xhrCompleteEventName||"xhr:complete",i=e.xhrModelLoadingAttribute=e.xhrModelLoadingAttribute||"xhrActivity",a=e.xhrEventName=e.xhrEventName||"xhr",h=e.xhrGlobalAttribute=e.xhrGlobalAttribute||"xhrEvents",s=e[h]=t.extend({},e.Events),c="success",f="error",u=function(e,t,r){this.method=e,this.model=t,this.options=r};u.prototype.abort=function(){this.aborted||(this.aborted=!0,this.preventDefault=!0,this.xhr&&this.xhr.abort())},t.extend(u.prototype,e.Events);var l=e.sync;e.sync=function(e,r,o){o=o||{},o.url||(o.url=t.result(r,"url"));var i=n(e,r,r,o);if(!i.preventDefault){var a=l.call(this,e,r,o);return i.xhr=a,a}},s.on(a+":read",function(e,t){t.on(c,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(f,function(){e.hadFetchError=!0})}),e.Model.prototype.whenFetched=e.Collection.whenFetched=function(e,r){function n(){e(o)}var o=this;if(this.hasBeenFetched)return e(this);var a=t.find(this[i],function(e){return"read"===e.method});a?(a.on("success",n),r&&a.on("error",r)):this.fetch({success:n,error:r})},e.forwardXhrEvents=function(e,n,o){var i=r(!t.isFunction(o)&&o);if(t.isFunction(o))try{e.on(a,i,n),o.call(this)}finally{e.off(a,i,n)}else{var h=o?a+":"+o:a;e.on(h,i,n)}},e.stopXhrForwarding=function(e,t,n){var o=r(n);e.off(a,o,t)};var d={};t.each({reset:e.Collection,clear:e.Model},function(e,r){var n=e.prototype[r];e.prototype[r]=function(e){("clear"===r||t.isUndefined(e))&&(this.hasBeenFetched=this.hadFetchError=!1),n.apply(this,arguments)}})});
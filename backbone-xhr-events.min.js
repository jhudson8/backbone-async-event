/*!
 * https://github.com/jhudson8/backbone-xhr-events v0.8.0;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(t,r){e(t,r)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t){e(t,require("underscore"))}:e(Backbone,_)}(function(e,t){function r(e){e=e||"_all";var t=d[e];return t||(t=function(t,r){"_all"!==e&&(options=r,r=t,t=e),n(r.method,this,r.model,r.options)},d[e]=t),t}function n(e,t,r,n){function u(e){var r=n[e];n[e]=function(n,a,u){if(e!==h||v.preventDefault||(v.trigger("after-send",n,a,u,v),n=v.data||n,!v.preventDefault)){r&&r.call(this,n,a,u);var f=l.indexOf(v);f>=0&&l.splice(f,1),0===l.length&&(t[i]=void 0,t.trigger(o,v));var s=e===h?[e,v]:[e,n,a,u,v];v.trigger.apply(v,s),s.splice(0,0,"complete"),v.trigger.apply(v,s)}}}var l=t[i]=t[i]||[],d=n&&n.event||e,v=new c(e,r,n),p=a+":"+d;t.trigger(a,d,v),t.trigger(p,v),t===r&&(f.trigger(a,d,t,v),f.trigger(p,t,v));var g=n.beforeSend;return n.beforeSend=function(e,t){if(v.xhr=e,v.settings=t,g){var r=g.call(this,e,t);if(r===!1)return r}return v.trigger("before-send",e,t,v),v.preventDefault?!1:void l.push(v)},u(h),u(s),v}var o=e.xhrCompleteEventName=e.xhrCompleteEventName||"xhr:complete",i=e.xhrModelLoadingAttribute=e.xhrModelLoadingAttribute||"xhrActivity",a=e.xhrEventName=e.xhrEventName||"xhr",u=e.xhrGlobalAttribute=e.xhrGlobalAttribute||"xhrEvents",f=e[u]=t.extend({},e.Events),h="success",s="error",c=function(e,t,r){this.method=e,this.model=t,this.options=r};c.prototype.abort=function(){this.aborted||(this.aborted=!0,this.preventDefault=!0,this.xhr&&this.xhr.abort())},t.extend(c.prototype,e.Events);var l=e.sync;e.sync=function(e,r,o){o=o||{},o.url||(o.url=t.result(r,"url"));var i=n(e,r,r,o);if(!i.preventDefault){var a=l.call(this,e,r,o);return i.xhr=a,a}},f.on(a+":read",function(e,t){t.on(h,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(s,function(){e.hadFetchError=!0})}),e.Model.prototype.whenFetched=e.Collection.whenFetched=function(e,r){function n(){e(o)}var o=this;if(this.hasBeenFetched)return e(this);var a=t.find(this[i],function(e){return"read"===e.method});a?(a.on("success",n),r&&a.on("error",r)):this.fetch({success:n,error:r})},e.forwardXhrEvents=function(e,n,o){var i=r(!t.isFunction(o)&&o);if(t.isFunction(o))try{e.on(a,i,n),o.call(this)}finally{e.off(a,i,n)}else{var u=o?a+":"+o:a;e.on(u,i,n)}},e.stopXhrForwarding=function(e,t,n){var o=r(n);e.off(a,o,t)};var d={}});
/*!
 * https://github.com/jhudson8/backbone-xhr-events v0.7.1;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["backbone","underscore"],function(t,r){e(t,r)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t){e(t,require("underscore"))}:e(Backbone,_)}(function(e,t){function r(e){e=e||"_all";var t=h[e];return t||(t=function(t,r){"_all"!==e&&(options=r,r=t,t=e),n(this,r.model,r.options,r.method)},h[e]=t),t}function n(r,n,c,l){function h(e){var t=c[e];c[e]=function(n,u,c){if(e!==f||p.preventDefault||(p.trigger("data",n,u,c,p),n=p.response||n,!p.preventDefault)){t&&t.call(this,n,u,c);var a=d.indexOf(p);a>=0&&d.splice(a,1),0===d.length&&(r[i]=void 0,r.trigger(o,p));var s=e===f?[e,p]:[e,n,u,c,p];p.trigger.apply(p,s),s.splice(0,0,"complete"),p.trigger.apply(p,s)}}}var d=r[i]=r[i]||[],v=c&&c.event||l,p=t.extend({},e.Events);p.method=l,p.options=c,p.model=n,d.push(p);var g=u+":"+v;r.trigger(u,v,p),r.trigger(g,p),r===n&&(a.trigger(u,v,r,p),a.trigger(g,r,p));var x=c.beforeSend;return c.beforeSend=function(e,t){if(p.xhr=e,p.settings=t,x){var r=x.call(this,e,t);if(r===!1)return r}return p.trigger("before-send",e,t,p),p.preventDefault?!1:void 0},h(f),h(s),p}var o=e.xhrCompleteEventName=e.xhrCompleteEventName||"xhr:complete",i=e.xhrModelLoadingAttribute=e.xhrModelLoadingAttribute||"xhrActivity",u=e.xhrEventName=e.xhrEventName||"xhr",c=e.xhrGlobalAttribute=e.xhrGlobalAttribute||"xhrEvents",a=e[c]=t.extend({},e.Events),f="success",s="error",l=e.sync;e.sync=function(e,r,o){o=o||{},o.url||(o.url=t.result(r,"url"));var i=n(r,r,o,e);return i.preventDefault?void 0:l.call(this,e,r,o)},a.on(u+":read",function(e,t){t.on(f,function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on(s,function(){e.hadFetchError=!0})}),e.Model.prototype.whenFetched=e.Collection.whenFetched=function(e,r){function n(){e(o)}var o=this;if(this.hasBeenFetched)return e(this);var u=t.find(this[i],function(e){return"read"===e.method});u?(u.on("success",n),r&&u.on("error",r)):this.fetch({success:n,error:r})},e.forwardXhrEvents=function(e,n,o){var i=r(!t.isFunction(o)&&o);if(t.isFunction(o))try{e.on(u,i,n),o.call(this)}finally{e.off(u,i,n)}else{var c=o?u+":"+o:u;e.on(c,i,n)}},e.stopXhrForwarding=function(e,t,n){var o=r(n);e.off(u,o,t)};var h={}});